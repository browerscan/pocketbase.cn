---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import ShowcaseBrowser from "../../components/showcase/ShowcaseBrowser";
import { POCKETBASE_URL, SITE_URL } from "../../lib/constants/config";

const DEFAULT_SORT = "-featured,-created";
const LIMIT = 24;

const q = (Astro.url.searchParams.get("q") || "").trim();
const category = (Astro.url.searchParams.get("category") || "").trim();
const sort =
  (Astro.url.searchParams.get("sort") || DEFAULT_SORT).trim() || DEFAULT_SORT;

const endpointUrl = new URL("/api/showcase/list", POCKETBASE_URL);
if (q) endpointUrl.searchParams.set("q", q);
if (category) endpointUrl.searchParams.set("category", category);
if (sort) endpointUrl.searchParams.set("sort", sort);
endpointUrl.searchParams.set("limit", String(LIMIT));
endpointUrl.searchParams.set("offset", "0");

let initial: {
  endpointUrl: string;
  items: unknown[];
  meta: Record<string, unknown>;
} | undefined;

try {
  const res = await fetch(endpointUrl.toString(), {
    headers: { Accept: "application/json" },
  });
  if (res.ok) {
    const json = await res.json();
    initial = {
      endpointUrl: endpointUrl.toString(),
      items: Array.isArray(json?.data) ? json.data : [],
      meta: json?.meta && typeof json.meta === "object" ? json.meta : {},
    };
  }
} catch {
  // SSR fetch failed - leave initial undefined so client will fetch
}

const hasFilters = Boolean(q || category || sort !== DEFAULT_SORT);
const canonical = new URL("/showcase/", SITE_URL).toString();

Astro.response.headers.set(
  "Cache-Control",
  hasFilters
    ? "no-store"
    : "public, max-age=60, s-maxage=300, stale-while-revalidate=600",
);
---

<BaseLayout
  title="PocketBase æ¡ˆä¾‹å±•ç¤º - çœŸå®é¡¹ç›®ä¸æˆåŠŸæ•…äº‹"
  description="æ¢ç´¢ä½¿ç”¨ PocketBase æ„å»ºçš„çœŸå®é¡¹ç›®æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ Web åº”ç”¨ã€ç§»åŠ¨åº”ç”¨ã€SaaS äº§å“ç­‰ã€‚è·å–çµæ„Ÿï¼Œå­¦ä¹ æœ€ä½³å®è·µã€‚"
  canonical={canonical}
  noindex={hasFilters}
>
  <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">PocketBase æ¡ˆä¾‹å±•ç¤º</h1>
      <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
        æ¢ç´¢ç¤¾åŒºä½¿ç”¨ PocketBase æ„å»ºçš„çœŸå®é¡¹ç›®ï¼Œè·å–çµæ„Ÿå’Œæœ€ä½³å®è·µã€‚
      </p>
    </div>
    <a
      class="inline-flex items-center justify-center rounded-md bg-brand-600 px-4 py-2 text-sm font-medium text-white hover:bg-brand-700"
      href="/showcase/submit"
    >
      æäº¤æ¡ˆä¾‹
    </a>
  </div>

  <!-- SEO Content Section -->
  <section class="mt-8 rounded-xl border border-neutral-200 bg-neutral-50 p-6 dark:border-neutral-800 dark:bg-neutral-900">
    <h2 class="text-lg font-semibold">ä¸ºä»€ä¹ˆå±•ç¤ºæ‚¨çš„é¡¹ç›®ï¼Ÿ</h2>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      åˆ†äº«æ‚¨çš„ PocketBase é¡¹ç›®å¯ä»¥å¸®åŠ©ç¤¾åŒºå…¶ä»–å¼€å‘è€…äº†è§£ PocketBase çš„å®é™…åº”ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¸ºæ‚¨çš„é¡¹ç›®å¸¦æ¥æ›å…‰æœºä¼šã€‚æ— è®ºæ˜¯ä¸€ä¸ªç®€å•çš„ä¸ªäººé¡¹ç›®ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¤æ‚çš„å•†ä¸šåº”ç”¨ï¼Œæˆ‘ä»¬éƒ½æ¬¢è¿æ‚¨çš„åˆ†äº«ã€‚
    </p>

    <h3 class="mt-6 text-md font-semibold">é¡¹ç›®ç±»å‹</h3>
    <ul class="mt-3 grid gap-3 md:grid-cols-2 text-sm text-neutral-600 dark:text-neutral-400">
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸŒ</span>
        <span><strong>Web åº”ç”¨ï¼š</strong>SaaS äº§å“ã€å†…å®¹ç®¡ç†ã€ç”µå•†å¹³å°ã€åä½œå·¥å…·</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ“±</span>
        <span><strong>ç§»åŠ¨åº”ç”¨ï¼š</strong>React Nativeã€Flutter åŸç”Ÿåº”ç”¨çš„åç«¯æœåŠ¡</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ®</span>
        <span><strong>æ¸¸æˆæœåŠ¡ï¼š</strong>æ’è¡Œæ¦œã€ç”¨æˆ·ç³»ç»Ÿã€æ¸¸æˆæ•°æ®å­˜å‚¨</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ¢</span>
        <span><strong>ä¼ä¸šåº”ç”¨ï¼š</strong>å†…éƒ¨å·¥å…·ã€ç®¡ç†ç³»ç»Ÿã€æ•°æ®åˆ†æå¹³å°</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ¤–</span>
        <span><strong>API æœåŠ¡ï¼š</strong>RESTful APIã€GraphQLã€å¾®æœåŠ¡åç«¯</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">âš¡</span>
        <span><strong>MVP äº§å“ï¼š</strong>å¿«é€ŸéªŒè¯æƒ³æ³•çš„åˆåˆ›é¡¹ç›®</span>
      </li>
    </ul>

    <h3 class="mt-6 text-md font-semibold">æäº¤æŒ‡å—</h3>
    <ol class="mt-3 list-decimal pl-6 space-y-2 text-sm text-neutral-600 dark:text-neutral-400">
      <li>é¡¹ç›®å¿…é¡»çœŸå®ä½¿ç”¨ PocketBase ä½œä¸ºåç«¯</li>
      <li>æä¾›é¡¹ç›®æè¿°ã€æŠ€æœ¯æ ˆå’Œä½¿ç”¨åœºæ™¯</li>
      <li>åˆ†äº«é¡¹ç›®é“¾æ¥ï¼ˆå¦‚æœå…¬å¼€ï¼‰æˆ–æˆªå›¾</li>
      <li>è¯´æ˜å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆ</li>
      <li>åŒ…å«æ‚¨çš„ GitHub æˆ–ç¤¾äº¤åª’ä½“é“¾æ¥ï¼ˆå¯é€‰ï¼‰</li>
    </ol>

    <h3 class="mt-6 text-md font-semibold">ç²¾é€‰é¡¹ç›®</h3>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      æˆ‘ä»¬ä¼šå®šæœŸæŒ‘é€‰å…·æœ‰ä»£è¡¨æ€§çš„é¡¹ç›®ä½œä¸º"ç²¾é€‰æ¡ˆä¾‹"ï¼Œåœ¨é¦–é¡µå±•ç¤ºã€‚ç²¾é€‰é¡¹ç›®é€šå¸¸å…·æœ‰ï¼šåˆ›æ–°çš„åº”ç”¨åœºæ™¯ã€å‡ºè‰²çš„æŠ€æœ¯å®ç°ã€è¯¦ç»†çš„å¼€å‘æ–‡æ¡£ã€è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒç­‰ç‰¹ç‚¹ã€‚
    </p>
  </section>

  <div class="mt-6">
    <ShowcaseBrowser
      initialParams={{ query: q, category, sort }}
      initial={initial}
      client:visible
    />
  </div>
</BaseLayout>

<script>
  // Prefetch next page on link hover for instant navigation
  document.querySelectorAll('a[href^="/showcase/"]').forEach(link => {
    link.addEventListener('mouseenter', () => {
      const href = link.getAttribute('href');
      if (href) {
        const prefetchLink = document.createElement('link');
        prefetchLink.rel = 'prefetch';
        prefetchLink.href = href;
        document.head.appendChild(prefetchLink);
      }
    }, { once: true });
  });
</script>
