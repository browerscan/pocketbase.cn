---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import PluginsBrowser from "../../components/plugins/PluginsBrowser";
import { POCKETBASE_URL, SITE_URL } from "../../lib/constants/config";

const DEFAULT_SORT = "-featured,-created";
const LIMIT = 24;

const q = (Astro.url.searchParams.get("q") || "").trim();
const category = (Astro.url.searchParams.get("category") || "").trim();
const sort = (Astro.url.searchParams.get("sort") || DEFAULT_SORT).trim() || DEFAULT_SORT;

const endpointUrl = new URL("/api/plugins/list", POCKETBASE_URL);
if (q) endpointUrl.searchParams.set("q", q);
if (category) endpointUrl.searchParams.set("category", category);
if (sort) endpointUrl.searchParams.set("sort", sort);
endpointUrl.searchParams.set("limit", String(LIMIT));
endpointUrl.searchParams.set("offset", "0");

let initial = {
  endpointUrl: endpointUrl.toString(),
  items: [] as unknown[],
  meta: {} as Record<string, unknown>,
};

try {
  const res = await fetch(endpointUrl.toString(), {
    headers: { Accept: "application/json" },
  });
  if (res.ok) {
    const json = await res.json();
    initial.items = Array.isArray(json?.data) ? json.data : [];
    initial.meta = json?.meta && typeof json.meta === "object" ? json.meta : {};
  }
} catch {
  // Best-effort SSR: fall back to client fetching.
}

const hasFilters = Boolean(q || category || sort !== DEFAULT_SORT);
const canonical = new URL("/plugins/", SITE_URL).toString();

Astro.response.headers.set(
  "Cache-Control",
  hasFilters
    ? "no-store"
    : "public, max-age=60, s-maxage=300, stale-while-revalidate=600",
);
---

<BaseLayout
  title="PocketBase æ’ä»¶å¸‚åœº - ç¤¾åŒºæ‰©å±•ä¸å·¥å…·é›†åˆ"
  description="æµè§ˆå’Œä¸‹è½½ PocketBase ç¤¾åŒºæ’ä»¶ï¼ŒåŒ…æ‹¬è®¤è¯æ‰©å±•ã€å­˜å‚¨é€‚é…å™¨ã€ä¸­é—´ä»¶ç­‰ã€‚å‘ç°ç²¾é€‰æ’ä»¶ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚"
  canonical={canonical}
  noindex={hasFilters}
>
  <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">PocketBase æ’ä»¶å¸‚åœº</h1>
      <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
        å‘ç°ç¤¾åŒºè´¡çŒ®çš„ PocketBase æ’ä»¶å’Œæ‰©å±•ï¼ŒåŠ é€Ÿæ‚¨çš„å¼€å‘æµç¨‹ã€‚
      </p>
    </div>
    <a
      class="inline-flex items-center justify-center rounded-md bg-brand-600 px-4 py-2 text-sm font-medium text-white hover:bg-brand-700"
      href="/plugins/submit"
    >
      æäº¤æ’ä»¶
    </a>
  </div>

  <!-- SEO Content Section -->
  <section class="mt-8 rounded-xl border border-neutral-200 bg-neutral-50 p-6 dark:border-neutral-800 dark:bg-neutral-900">
    <h2 class="text-lg font-semibold">ä»€ä¹ˆæ˜¯ PocketBase æ’ä»¶ï¼Ÿ</h2>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      PocketBase æ’ä»¶æ˜¯ç”±ç¤¾åŒºå¼€å‘è€…åˆ›å»ºçš„æ‰©å±•æ¨¡å—ï¼Œå¯ä»¥ä¸º PocketBase æ·»åŠ é¢å¤–çš„åŠŸèƒ½å’Œé›†æˆã€‚æ’ä»¶å¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿå®ç°å¸¸è§åŠŸèƒ½ï¼Œå¦‚ç¬¬ä¸‰æ–¹è®¤è¯ã€äº‘å­˜å‚¨é›†æˆã€é‚®ä»¶å‘é€ã€çŸ­ä¿¡éªŒè¯ç­‰ï¼Œè€Œæ— éœ€ä»å¤´å¼€å§‹ç¼–å†™ä»£ç ã€‚
    </p>

    <h3 class="mt-6 text-md font-semibold">æ’ä»¶ç±»å‹</h3>
    <ul class="mt-3 grid gap-3 md:grid-cols-2 text-sm text-neutral-600 dark:text-neutral-400">
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ”</span>
        <span><strong>è®¤è¯æ’ä»¶ï¼š</strong>æ”¯æŒå¾®ä¿¡ç™»å½•ã€æ”¯ä»˜å®ç™»å½•ã€ä¼ä¸šå¾®ä¿¡ç­‰å›½å†… OAuth æä¾›å•†</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">â˜ï¸</span>
        <span><strong>å­˜å‚¨æ’ä»¶ï¼š</strong>é›†æˆé˜¿é‡Œäº‘ OSSã€è…¾è®¯äº‘ COSã€ä¸ƒç‰›äº‘ç­‰å¯¹è±¡å­˜å‚¨æœåŠ¡</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ“§</span>
        <span><strong>é‚®ä»¶æ’ä»¶ï¼š</strong>æ”¯æŒè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ã€SendGrid ç­‰é‚®ä»¶æœåŠ¡</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ“±</span>
        <span><strong>çŸ­ä¿¡æ’ä»¶ï¼š</strong>é›†æˆå›½å†…çŸ­ä¿¡æœåŠ¡å•†ï¼Œæ”¯æŒéªŒè¯ç å’Œé€šçŸ¥</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ””</span>
        <span><strong>é€šçŸ¥æ’ä»¶ï¼š</strong>æ”¯æŒå¾®ä¿¡å…¬ä¼—å·ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡æ¨é€</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-brand-600">ğŸ› ï¸</span>
        <span><strong>å·¥å…·æ’ä»¶ï¼š</strong>æ•°æ®è¿ç§»ã€å¤‡ä»½æ¢å¤ã€æ€§èƒ½ç›‘æ§ç­‰å®ç”¨å·¥å…·</span>
      </li>
    </ul>

    <h3 class="mt-6 text-md font-semibold">å¦‚ä½•ä½¿ç”¨æ’ä»¶</h3>
    <ol class="mt-3 list-decimal pl-6 space-y-2 text-sm text-neutral-600 dark:text-neutral-400">
      <li>æµè§ˆæ’ä»¶å¸‚åœºï¼Œæ‰¾åˆ°æ‚¨éœ€è¦çš„æ’ä»¶</li>
      <li>æŸ¥çœ‹æ’ä»¶è¯¦æƒ…ï¼Œäº†è§£åŠŸèƒ½å’Œå®‰è£…è¯´æ˜</li>
      <li>æ ¹æ®æ’ä»¶ç±»å‹ï¼Œé€šè¿‡ JS Hooks æˆ– Go æ‰©å±•é›†æˆåˆ°æ‚¨çš„ PocketBase å®ä¾‹</li>
      <li>æŒ‰ç…§æ’ä»¶æ–‡æ¡£è¿›è¡Œé…ç½®å³å¯ä½¿ç”¨</li>
    </ol>

    <h3 class="mt-6 text-md font-semibold">æäº¤æ‚¨çš„æ’ä»¶</h3>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      å¼€å‘äº†æœ‰ç”¨çš„ PocketBase æ’ä»¶ï¼Ÿæ¬¢è¿æäº¤åˆ°æˆ‘ä»¬çš„æ’ä»¶å¸‚åœºï¼Œå¸®åŠ©æ›´å¤šå¼€å‘è€…ï¼è¯·ç¡®ä¿æ’ä»¶ä»£ç è´¨é‡è‰¯å¥½ï¼ŒåŒ…å«å®Œæ•´çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹ã€‚
    </p>
  </section>

  <div class="mt-6">
    <PluginsBrowser
      initialParams={{ query: q, category, sort }}
      initial={initial}
      client:visible
    />
  </div>
</BaseLayout>

<script>
  // Prefetch next page on link hover for instant navigation
  document.querySelectorAll('a[href^="/plugins/"]').forEach(link => {
    link.addEventListener('mouseenter', () => {
      const href = link.getAttribute('href');
      if (href) {
        const prefetchLink = document.createElement('link');
        prefetchLink.rel = 'prefetch';
        prefetchLink.href = href;
        document.head.appendChild(prefetchLink);
      }
    }, { once: true });
  });
</script>
