---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import DownloadsBrowser from "../../components/downloads/DownloadsBrowser";
import NewsletterForm from "../../components/newsletter/NewsletterForm";
import { POCKETBASE_URL, SITE_URL } from "../../lib/constants/config";

const pocketBaseDownloadUrl = "https://github.com/pocketbase/pocketbase/releases";

const downloadsDescription = "下载 PocketBase 最新版本，支持 Windows、macOS、Linux 多平台，提供 SHA256 校验信息与版本历史记录。国内高速下载镜像，快速获取 PocketBase。";

const softwareAppSchemaData = {
  downloadUrl: pocketBaseDownloadUrl
};

const versionParam = (Astro.url.searchParams.get("version") || "").trim();

let versions: string[] = [];
let version = "";
let files: unknown[] = [];

try {
  const res = await fetch(new URL("/api/downloads/versions", POCKETBASE_URL).toString(), {
    headers: { Accept: "application/json" },
  });
  if (res.ok) {
    const json = await res.json();
    versions = Array.isArray(json?.data) ? (json.data as string[]) : [];
  }
} catch {
  versions = [];
}

if (versionParam && versions.includes(versionParam)) version = versionParam;
else version = versions[0] || "";

if (version) {
  try {
    const u = new URL("/api/downloads/files", POCKETBASE_URL);
    u.searchParams.set("version", version);
    const res2 = await fetch(u.toString(), { headers: { Accept: "application/json" } });
    if (res2.ok) {
      const json2 = await res2.json();
      files = Array.isArray(json2?.data) ? json2.data : [];
    }
  } catch {
    files = [];
  }
}

const canonical = new URL("/downloads/", SITE_URL).toString();
const hasFilters = Boolean(versionParam);

Astro.response.headers.set(
  "Cache-Control",
  hasFilters
    ? "no-store"
    : "public, max-age=120, s-maxage=600, stale-while-revalidate=1200",
);
---

<BaseLayout
  title="下载 PocketBase - Windows、macOS、Linux 多平台版本"
  description={downloadsDescription}
  schemaType="SoftwareApplication"
  schemaData={softwareAppSchemaData}
  canonical={canonical}
  noindex={hasFilters}
>
  <h1 class="text-2xl font-semibold tracking-tight">下载 PocketBase</h1>
  <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
    获取最新版本的 PocketBase，支持多种操作系统和架构。
  </p>

  <!-- SEO Content Section -->
  <section class="mt-8 rounded-xl border border-neutral-200 bg-neutral-50 p-6 dark:border-neutral-800 dark:bg-neutral-900">
    <h2 class="text-lg font-semibold">支持的平台</h2>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      PocketBase 提供预编译的二进制文件，支持主流操作系统和 CPU 架构。下载后解压即可运行，无需安装依赖。
    </p>

    <div class="mt-6 grid gap-4 md:grid-cols-2">
      <div class="rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-800 dark:bg-neutral-950">
        <div class="flex items-center gap-3">
          <span class="text-2xl">Windows</span>
        </div>
        <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
          Windows 10/11 (amd64)，下载 .zip 文件，解压后运行 pocketbase.exe
        </p>
      </div>
      <div class="rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-800 dark:bg-neutral-950">
        <div class="flex items-center gap-3">
          <span class="text-2xl">macOS</span>
        </div>
        <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
          macOS 10.15+ (amd64/arm64)，下载 .zip 文件，解压后在终端运行
        </p>
      </div>
      <div class="rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-800 dark:bg-neutral-950">
        <div class="flex items-center gap-3">
          <span class="text-2xl">Linux</span>
        </div>
        <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
          Linux (amd64/arm64/arm)，下载 .zip 文件，解压后添加执行权限运行
        </p>
      </div>
      <div class="rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-800 dark:bg-neutral-950">
        <div class="flex items-center gap-3">
          <span class="text-2xl">Docker</span>
        </div>
        <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
          使用 Docker 部署：docker run -p 8090:8090 spectmax/pocketbase
        </p>
      </div>
    </div>

    <h3 class="mt-6 text-md font-semibold">安装步骤</h3>
    <ol class="mt-3 list-decimal pl-6 space-y-2 text-sm text-neutral-600 dark:text-neutral-400">
      <li>根据您的操作系统选择对应的版本下载</li>
      <li>解压下载的文件到任意目录</li>
      <li>Linux/macOS 用户添加执行权限：<code class="bg-neutral-200 dark:bg-neutral-800 px-1 rounded">chmod +x pocketbase</code></li>
      <li>运行服务：<code class="bg-neutral-200 dark:bg-neutral-800 px-1 rounded">./pocketbase serve</code></li>
      <li>访问 http://localhost:8090/_/ 设置管理员账号</li>
    </ol>

    <h3 class="mt-6 text-md font-semibold">文件校验</h3>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      为确保下载文件的完整性和安全性，建议验证 SHA256 校验和。Linux/macOS 可使用以下命令：
    </p>
    <pre class="mt-2 bg-neutral-100 dark:bg-neutral-900 p-3 rounded text-sm overflow-x-auto"><code>shasum -a 256 pocketbase.zip</code></pre>
    <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
      Windows PowerShell 用户可使用：
    </p>
    <pre class="mt-2 bg-neutral-100 dark:bg-neutral-900 p-3 rounded text-sm overflow-x-auto"><code>Get-FileHash pocketbase.zip -Algorithm SHA256</code></pre>

    <h3 class="mt-6 text-md font-semibold">版本说明</h3>
    <p class="mt-3 text-sm text-neutral-600 dark:text-neutral-400">
      PocketBase 遵循语义化版本规范（SemVer）。每个版本号包含主版本、次版本和修订号。我们推荐生产环境使用最新的稳定版本。开发中的版本可能会有新功能，但稳定性可能不如正式版本。
    </p>
  </section>

  <div class="mt-6">
    <DownloadsBrowser initial={{ versions, version, files }} client:visible />
  </div>

  <section class="mt-12 rounded-xl border border-neutral-200 p-6 dark:border-neutral-800">
    <h2 class="text-lg font-semibold">订阅版本更新</h2>
    <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
      订阅后，当 PocketBase 发布新版本会发送邮件通知（需要确认订阅）。
    </p>
    <div class="mt-4 max-w-md">
      <NewsletterForm client:idle />
    </div>
  </section>
</BaseLayout>
