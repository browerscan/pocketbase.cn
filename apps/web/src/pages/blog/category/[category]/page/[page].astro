---
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import BlogArchive from "../../../../../components/blog/BlogArchive.astro";
import { getCollection } from "astro:content";
import { POSTS_PER_PAGE } from "../../../../../lib/constants/blog";
import { SITE_URL } from "../../../../../lib/constants/config";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  const categories = [...new Set(allPosts.map((p) => String(p.data.category || "未分类")))];

  const paths: { params: { category: string; page: string } }[] = [];
  for (const category of categories) {
    const total = allPosts.filter((p) => String(p.data.category || "未分类") === category).length;
    const totalPages = Math.ceil(total / POSTS_PER_PAGE);
    for (let page = 2; page <= totalPages; page++) {
      paths.push({ params: { category, page: String(page) } });
    }
  }

  return paths;
}

const { category, page } = Astro.params;
const selectedCategory = String(category || "").trim();
const currentPage = Math.max(2, parseInt(page || "2", 10));
if (!selectedCategory) return Astro.redirect("/blog/");

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const filtered = allPosts
  .filter((p) => String(p.data.category || "未分类") === selectedCategory)
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE) || 1;
const safePage = Math.min(currentPage, totalPages);

const startIndex = (safePage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const posts = filtered.slice(startIndex, endIndex);

const categories = [...new Set(allPosts.map((p) => String(p.data.category || "未分类")))];
const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

const urlForPage = (pageNum: number) =>
  pageNum <= 1
    ? `/blog/category/${encodeURIComponent(selectedCategory)}/`
    : `/blog/category/${encodeURIComponent(selectedCategory)}/page/${pageNum}/`;
---

<BaseLayout
  title={`${selectedCategory} - 第 ${safePage} 页 - 博客分类 - PocketBase.cn`}
  description={`浏览 PocketBase.cn 博客分类「${selectedCategory}」的文章与教程。`}
>
  <Fragment slot="head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="PocketBase.cn 博客"
      href={`${SITE_URL}/blog/rss.xml`}
    />
  </Fragment>

  <BlogArchive
    heading={`分类：${selectedCategory} - 第 ${safePage} 页`}
    intro={`共 ${filtered.length} 篇文章`}
    posts={posts}
    categories={categories}
    tags={tags}
    selectedCategory={selectedCategory}
    currentPage={safePage}
    totalPages={totalPages}
    urlForPage={urlForPage}
  />
</BaseLayout>

