---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { SITE_URL } from "../../lib/constants/config";
import { POSTS_PER_PAGE } from "../../lib/constants/blog";
import BlogArchive from "../../components/blog/BlogArchive.astro";

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) =>
  b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);
const posts = sortedPosts.slice(0, POSTS_PER_PAGE);

const categories = [...new Set(allPosts.map((p) => p.data.category))];
const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

const urlForPage = (pageNum: number) => (pageNum <= 1 ? "/blog/" : `/blog/page/${pageNum}/`);
---

<BaseLayout
  title="博客 - PocketBase.cn"
  description="PocketBase 技术文章、教程、最佳实践与对比分析。"
>
  <Fragment slot="head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="PocketBase.cn 博客"
      href={`${SITE_URL}/blog/rss.xml`}
    />
  </Fragment>

  <BlogArchive
    heading="博客"
    intro="技术文章、教程、最佳实践与对比分析"
    posts={posts}
    categories={categories}
    tags={tags}
    currentPage={1}
    totalPages={totalPages || 1}
    urlForPage={urlForPage}
  />
</BaseLayout>
