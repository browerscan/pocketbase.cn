---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import BlogArchive from "../../../../components/blog/BlogArchive.astro";
import { getCollection } from "astro:content";
import { POSTS_PER_PAGE } from "../../../../lib/constants/blog";
import { SITE_URL } from "../../../../lib/constants/config";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))].filter(Boolean);
  return tags.map((tag) => ({ params: { tag } }));
}

const { tag } = Astro.params;
const selectedTag = String(tag || "").trim();
if (!selectedTag) return Astro.redirect("/blog/");

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const filtered = allPosts
  .filter((p) => Array.isArray(p.data.tags) && p.data.tags.includes(selectedTag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE) || 1;
const posts = filtered.slice(0, POSTS_PER_PAGE);

const categories = [...new Set(allPosts.map((p) => String(p.data.category || "未分类")))];
const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

const urlForPage = (pageNum: number) =>
  pageNum <= 1
    ? `/blog/tag/${encodeURIComponent(selectedTag)}/`
    : `/blog/tag/${encodeURIComponent(selectedTag)}/page/${pageNum}/`;
---

<BaseLayout
  title={`${selectedTag} - 博客标签 - PocketBase.cn`}
  description={`浏览 PocketBase.cn 博客标签「${selectedTag}」的文章与教程。`}
>
  <Fragment slot="head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="PocketBase.cn 博客"
      href={`${SITE_URL}/blog/rss.xml`}
    />
  </Fragment>

  <BlogArchive
    heading={`标签：${selectedTag}`}
    intro={`共 ${filtered.length} 篇文章`}
    posts={posts}
    categories={categories}
    tags={tags}
    selectedTag={selectedTag}
    currentPage={1}
    totalPages={totalPages}
    urlForPage={urlForPage}
  />
</BaseLayout>

