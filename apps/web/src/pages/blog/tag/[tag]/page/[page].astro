---
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import BlogArchive from "../../../../../components/blog/BlogArchive.astro";
import { getCollection } from "astro:content";
import { POSTS_PER_PAGE } from "../../../../../lib/constants/blog";
import { SITE_URL } from "../../../../../lib/constants/config";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))].filter(Boolean);

  const paths: { params: { tag: string; page: string } }[] = [];
  for (const tag of tags) {
    const total = allPosts.filter((p) => Array.isArray(p.data.tags) && p.data.tags.includes(tag)).length;
    const totalPages = Math.ceil(total / POSTS_PER_PAGE);
    for (let page = 2; page <= totalPages; page++) {
      paths.push({ params: { tag, page: String(page) } });
    }
  }
  return paths;
}

const { tag, page } = Astro.params;
const selectedTag = String(tag || "").trim();
const currentPage = Math.max(2, parseInt(page || "2", 10));
if (!selectedTag) return Astro.redirect("/blog/");

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const filtered = allPosts
  .filter((p) => Array.isArray(p.data.tags) && p.data.tags.includes(selectedTag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE) || 1;
const safePage = Math.min(currentPage, totalPages);

const startIndex = (safePage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const posts = filtered.slice(startIndex, endIndex);

const categories = [...new Set(allPosts.map((p) => String(p.data.category || "未分类")))];
const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

const urlForPage = (pageNum: number) =>
  pageNum <= 1
    ? `/blog/tag/${encodeURIComponent(selectedTag)}/`
    : `/blog/tag/${encodeURIComponent(selectedTag)}/page/${pageNum}/`;
---

<BaseLayout
  title={`${selectedTag} - 第 ${safePage} 页 - 博客标签 - PocketBase.cn`}
  description={`浏览 PocketBase.cn 博客标签「${selectedTag}」的文章与教程。`}
>
  <Fragment slot="head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="PocketBase.cn 博客"
      href={`${SITE_URL}/blog/rss.xml`}
    />
  </Fragment>

  <BlogArchive
    heading={`标签：${selectedTag} - 第 ${safePage} 页`}
    intro={`共 ${filtered.length} 篇文章`}
    posts={posts}
    categories={categories}
    tags={tags}
    selectedTag={selectedTag}
    currentPage={safePage}
    totalPages={totalPages}
    urlForPage={urlForPage}
  />
</BaseLayout>

